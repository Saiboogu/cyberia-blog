#!/bin/bash
# NEWPOST  
# Built for Cyberia to compliment Arise
# https://github.com/Saiboogu/cyberia-blog
# Sets up a new foler and index.md file for a new post
# Usage: ./newpost "Post Title"

# Get list of directories in arise-source for section choices
directories=$(find arise-source/ -maxdepth 1 -type d -not -name arise-source -not -wholename arise-source/config -not -wholename arise-source/privacy | awk -F'/' '{print $2}')
options=($directories)
max=${#options[@]}

# Print the big pretty logo since this is our tool and I'm having fun
cat << 'EOF'
┌────────────────────────────────────────────────────────┐
│   ██████╗██╗   ██╗██████╗ ███████╗██████╗ ██╗ █████╗   │
│  ██╔════╝╚██╗ ██╔╝██╔══██╗██╔════╝██╔══██╗██║██╔══██╗  │
│  ██║      ╚████╔╝ ██████╔╝█████╗  ██████╔╝██║███████║  │
│  ██║       ╚██╔╝  ██╔══██╗██╔══╝  ██╔══██╗██║██╔══██║  │
│  ╚██████╗   ██║   ██████╔╝███████╗██║  ██║██║██║  ██║  │
│   ╚═════╝   ╚═╝   ╚═════╝ ╚══════╝╚═╝  ╚═╝╚═╝╚═╝  ╚═╝  │
├───────────────────New─Post─Creator─────────────────────┤
│                                                        │
│   Because we kept copying an existing post,            │
│   then editing the wrong one                           │
└────────────────────────────────────────────────────────┘

Usage: ./newpost "Post Title"
  or   ./newpost 
Interactive mode will prompt for title and section either way

EOF

while true; do
    # Check arguments for post title, otherwise prompt user
    if [ -z "$1" ]; then
      read -p "New Blog Title: " post_title
    else
      post_title=$1
    fi

    # Create lowercase, underscored version of title for folder name
    post_slug=$(echo "$post_title" | tr '[:upper:]' '[:lower:]' | tr -d '[:punct:]' | tr -s ' ' | sed 's/^ *//;s/ *$//' | tr ' ' '_')

    # Prompt user to accept this automatic slug by pressing enter, or enter a new one
    while true; do
        read -p "Post Slug: $post_slug (press enter to accept, or enter a new one): " new_slug
        [[ -n "$new_slug" ]] && post_slug=$(echo $new_slug | tr '[:upper:]' '[:lower:]' | tr ' ' '_')
        [[ "$post_slug" =~ ^[a-z0-9_-]+$ ]] && break || echo "Invalid slug format"
    done

    # Prompt user to select a section for the new post
    while true; do
        echo "Please select from the following sections:"
        for i in "${!options[@]}"; do
        echo "$((i + 1)). ${options[i]}"
        done
        read -p "Enter your choice (1-$max): " -n1 choice
        echo
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le $max ]; then
            dir=${options[choice - 1]}
            break
        else
            printf "Invalid input. Please enter a number between 1 and $max.\n\n"
        fi
    done

    # Show summary and confirm
    echo
    echo "Summary of new post:"
    echo "Title: $post_title"
    echo "Slug: $post_slug"
    echo "Section: $dir"
    read -p "Create this post? (y/n): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        break
    else
        echo "Let's try again..."
        echo
    fi
done

printf "============== Creating New $dir ==============\n"
printf "copying template to $dir/$post_slug ....\n"

# Create new post folder and copy template files
cp -r arise-source/config/new_post_template arise-source/$dir/$post_slug
printf "Setting date and title in index.md .....\n"

# Set date and title in post markdown file
sed -i arise-source/$dir/$post_slug/index.md -e "s/{{title}}/$(echo $post_title)/g"
sed -i arise-source/$dir/$post_slug/index.md -e "s/{{date}}/$(date '+%Y-%m-%d')/g"

printf "Done!\n\n"

